#####################################################
# Makefile for stunnel by Michal Trojnara 1998-1999 #
#####################################################

VERSION=@VERSION@
HOST=@host@
DESTDIR=/usr
SBINDIR=$(DESTDIR)/sbin
MANDIR=$(DESTDIR)/man/man8
SSLDIR=@SSLDIR@
CERTDIR=$(SSLDIR)/certs

CC=@CC@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@ -Wall -I$(SSLDIR)/include
LIBS=-L$(SSLDIR)/lib @LIBS@ -lssl -lcrypto
OBJS=stunnel.o sthreads.o log.o

stunnel: $(OBJS)
	$(CC) $(LDFLAGS) -o stunnel $(OBJS) $(LIBS)
#	mkdir -p ../distrib
#	gzip < stunnel > ../distrib/stunnel-$(VERSION)-$(HOST).gz

# .o:
# 	$(CC) -c $(CFLAGS) $@

stunnel.html: man2html.pl stunnel.8
	./man2html.pl < stunnel.8 > stunnel.html

cert:
	rm -f stunnel.pem
	make stunnel.pem

stunnel.pem:
	$(SSLDIR)/bin/openssl req -new -x509 -days 365 -config stunnel.cnf \
		-out stunnel.pem -keyout stunnel.pem
	$(SSLDIR)/bin/openssl x509 -subject -dates -fingerprint -noout \
		-in stunnel.pem

$(SBINDIR)/stunnel: stunnel
	mkdir -p $(SBINDIR)
	$(INSTALL) -m 711 stunnel $(SBINDIR)

$(MANDIR)/stunnel.8: stunnel.8
	mkdir -p $(MANDIR)
	$(INSTALL) -m 644 stunnel.8 $(MANDIR)

$(CERTDIR)/stunnel.pem: stunnel.pem
	mkdir -p $(CERTDIR)
	$(INSTALL) -m 600 stunnel.pem $(CERTDIR)

install: $(SBINDIR)/stunnel $(MANDIR)/stunnel.8 $(CERTDIR)/stunnel.pem

clean:
	rm -f stunnel $(OBJS) config.log core

dist_clean: clean
	rm -f config.cache Makefile config.h

distrib: dist_clean
	mkdir -p ../distrib
	cp -f stunnel.exe ../distrib/stunnel-$(VERSION).exe
	tar -cf - -C .. stunnel | gzip > ../distrib/stunnel-$(VERSION).tar.gz
